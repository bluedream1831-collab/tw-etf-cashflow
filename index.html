<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- ç¤¾ç¾¤åˆ†äº«å„ªåŒ– (OG Tags) -->
    <meta property="og:title" content="ETF ç¾é‡‘æµè©¦ç®—ç¥å™¨ (v33) | å­˜è‚¡æ—å¿…å‚™">
    <meta property="og:description" content="ã€å…§å»ºå®‰è£æ•™å­¸ã€‘è‡ªå‹•è©¦ç®—äºŒä»£å¥ä¿ã€å¹´åŒ–æ®–åˆ©ç‡ã€æ¯æœˆç¾é‡‘æµã€‚æ”¯æ´æ¡Œé¢æ·å¾‘ï¼Œåƒ App ä¸€æ¨£å¥½ç”¨ï¼">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/2910/2910280.png">

    <!-- PWA å„ªåŒ– -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#198754">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3310/3310624.png">
    
    <title>ETF ç¾é‡‘æµè©¦ç®— (v33 å®‰è£æ•™å­¸ç‰ˆ)</title>
    
    <!-- Vue 3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        [v-cloak] { display: none !important; }

        :root {
            --primary-color: #198754;
            --highlight-bg: #fffde7;
            --bg-color: #f8f9fa;
            --input-bg: #f8f9fa; 
            --input-border: #ced4da; 
            --top-bar-height: 112px;
        }

        body { 
            background-color: var(--bg-color); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #333;
            font-size: 14px;
            padding-bottom: 90px; 
            padding-top: env(safe-area-inset-top);
        }

        .container-fluid { padding-left: 0; padding-right: 0; max-width: 800px; margin: 0 auto; }

        /* --- é ‚éƒ¨å°èˆª (Sticky) --- */
        .top-bar {
            background: white; 
            padding: 8px 10px 0 10px; 
            border-bottom: 1px solid #ccc;
            position: sticky; top: 0; z-index: 1020;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }

        .tools-bar {
            display: flex; gap: 5px; padding: 0 0 8px 0; background: #fff;
        }
        .btn-tool {
            flex: 1; border: 1px solid #dee2e6; background: #fff; color: #555;
            font-size: 12px; font-weight: bold; padding: 6px 0; border-radius: 6px;
            display: flex; align-items: center; justify-content: center; gap: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-tool:active { background: #f0f0f0; transform: translateY(1px); }
        .btn-tool-export { color: #0d6efd; border-color: #cfe2ff; background: #f8fbff; }
        .btn-tool-import { color: #6610f2; border-color: #e0cffc; background: #fbf8ff; }
        .btn-tool-chart { color: #d63384; border-color: #f7d6e6; background: #fff8fb; }

        .btn-share {
            background: #0d6efd; color: white; border: none; border-radius: 20px;
            padding: 2px 12px; font-size: 12px; font-weight: bold;
            transition: transform 0.2s;
        }
        .btn-share:active { transform: scale(0.9); }

        .month-bar { 
            display: flex; gap: 2px; justify-content: center; overflow-x: auto; 
            padding-bottom: 8px; background: white;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .month-bar::-webkit-scrollbar { display: none; }

        .month-btn {
            flex: 1; min-width: 25px; height: 32px;
            border-radius: 4px; font-weight: bold; border: 1px solid #eee;
            background: #fff; color: #666; font-size: 13px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .month-btn.active {
            background-color: var(--primary-color); color: white; border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
        }

        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; }
        .custom-table th {
            background-color: #e9ecef; color: #495057; padding: 8px 4px;
            font-size: 13px; text-align: center; border-bottom: 2px solid #ccc;
            white-space: nowrap; 
            position: sticky; top: var(--top-bar-height); z-index: 1010;
        }
        
        .custom-table td { padding: 8px 4px; vertical-align: top; border-bottom: 1px solid #eee; }

        .delete-btn { font-size: 11px; color: #dc3545; opacity: 0.3; cursor: pointer; margin-left: 6px; }
        .delete-btn:hover { opacity: 1; }
        .highlight-row { background-color: var(--highlight-bg) !important; }

        .etf-info-cell { text-align: left; padding-left: 8px !important; }
        .etf-code { font-weight: 800; font-size: 15px; color: #2c3e50; }
        .etf-name { font-size: 11px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 85px;}

        .badge-pill { display: inline-block; padding: 1px 4px; border-radius: 3px; font-size: 10px; margin-left: 4px; vertical-align: text-top; }
        .badge-m { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; } 
        .badge-q { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        .input-group-custom { display: flex; flex-direction: column; gap: 4px; }
        .input-enhanced {
            width: 100%; text-align: right; border: 1px solid var(--input-border); border-radius: 4px;
            padding: 4px 6px; font-size: 14px; font-weight: 700; color: #333; background-color: var(--input-bg);
        }
        .input-mini {
            font-size: 12px; padding: 2px 4px; color: #666; border: 1px solid #eee; background: #fff; text-align: right; border-radius: 4px;
        }
        .input-enhanced:focus, .input-mini:focus {
            background-color: #fff; border-color: var(--primary-color); outline: none; 
        }

        .amount-cell { text-align: right; padding-right: 8px !important; }
        .amount-text { font-size: 15px; font-weight: 800; color: var(--primary-color); letter-spacing: 0.5px; display: block; }
        .sub-info { font-size: 10px; display: block; line-height: 1.4; margin-top: 2px; }
        .nh-warning { color: #dc3545; font-weight: bold; }
        .yield-text { color: #fd7e14; }

        .footer-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(33, 37, 41, 0.98); color: #fff;
            padding: 10px 15px; z-index: 1050;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .total-amount { font-size: 18px; font-weight: bold; color: #76ff03; }

        .privacy-footer {
            text-align: center; padding: 15px 10px 5px 10px;
            color: #999; font-size: 11px; line-height: 1.5;
        }

        .help-section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .help-section:last-child { border-bottom: none; }
        .help-title { font-weight: bold; color: #333; margin-bottom: 8px; display: flex; align-items: center; }
        .help-title i { width: 24px; text-align: center; margin-right: 5px; }

        .print-only-header { display: none; }

        @media print {
            .no-print, .month-bar, .footer-bar, .top-bar, .tools-bar, .privacy-footer { display: none !important; }
            .print-only-header { display: block; text-align: center; margin-bottom: 20px; font-size: 20px; font-weight: bold;}
            .custom-table th, .custom-table td { border: 1px solid #000; }
            .custom-table th { position: static; }
            .input-enhanced, .input-mini { border: none; background: transparent; text-align: right; padding: 0; }
            .amount-text { color: #000 !important; }
            .delete-btn { display: none; }
        }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <div class="top-bar no-print" ref="topBar">
        <div class="container-fluid">
            <div class="header-row">
                <div class="d-flex align-items-center">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    <span class="fw-bold text-dark fs-6">ETF ç¾é‡‘æµ</span>
                </div>
                
                <div class="d-flex align-items-center">
                    <button class="btn btn-share me-2" @click="shareApp">
                        <i class="fas fa-share-nodes me-1"></i>åˆ†äº«
                    </button>
                    
                    <button class="btn btn-light btn-sm border" type="button" data-bs-toggle="dropdown" style="width:32px; height:32px; border-radius:50%;">
                        <i class="fas fa-bars text-secondary"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0" style="font-size: 13px;">
                        <li><a class="dropdown-item py-2 fw-bold text-primary" href="#" data-bs-toggle="modal" data-bs-target="#addEtfModal"><i class="fas fa-plus-circle me-2"></i>æ–°å¢ ETF</a></li>
                        <li><a class="dropdown-item py-2" href="#" data-bs-toggle="modal" data-bs-target="#helpModal"><i class="fas fa-book me-2"></i>æ“ä½œèªªæ˜</a></li>
                        <li><hr class="dropdown-divider my-1"></li>
                        <li><a class="dropdown-item py-2" href="#" @click.prevent="exportCSV"><i class="fas fa-file-csv me-2"></i>åŒ¯å‡º Excel</a></li>
                        <li><a class="dropdown-item py-2" href="#" @click.prevent="printPage"><i class="fas fa-print me-2"></i>åˆ—å° / PDF</a></li>
                        <li><hr class="dropdown-divider my-1"></li>
                        <li><a class="dropdown-item py-2 text-danger" href="#" @click.prevent="resetToDefault"><i class="fas fa-undo me-2"></i>é‡ç½®æ¸…å–®</a></li>
                    </ul>
                </div>
            </div>

            <div class="tools-bar">
                <button class="btn-tool btn-tool-export" @click.prevent="backupDataJSON">
                    <i class="fas fa-file-export"></i> åŒ¯å‡ºå‚™ä»½
                </button>
                <button class="btn-tool btn-tool-import" @click.prevent="triggerImport">
                    <i class="fas fa-file-import"></i> åŒ¯å…¥é‚„åŸ
                </button>
                <button class="btn-tool btn-tool-chart" @click="openSummary">
                    <i class="fas fa-chart-pie"></i> å¹´åº¦ç¸½è¦½
                </button>
            </div>

            <div class="month-bar">
                <div v-for="m in 12" :key="m" 
                     class="month-btn" 
                     :class="{ active: currentMonth === m }"
                     @click="currentMonth = m">
                    {{ m }}
                </div>
            </div>
        </div>
    </div>

    <input type="file" ref="fileInput" @change="handleFileImport" accept=".json" style="display: none;">

    <div class="container-fluid">
        <h3 class="print-only-header">{{ currentMonth }}æœˆä»½ ETF é ˜æ¯å ±è¡¨</h3>

        <table class="custom-table">
            <thead>
                <tr>
                    <th width="28%" style="text-align:left; padding-left:8px;">ä»£è™Ÿ</th>
                    <th width="22%">è‚¡æ•¸ / å‡åƒ¹</th>
                    <th width="20%">é…æ¯</th>
                    <th width="30%" style="text-align:right; padding-right:8px;">è©¦ç®—</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="etf in filteredList" :key="etf.id" :class="{ 'highlight-row': isHighlight(etf) }">
                    <td class="etf-info-cell">
                        <div class="etf-info-wrapper">
                            <div>
                                <span class="etf-code">{{ etf.id }}</span>
                                <span v-if="etf.freq==='M'" class="badge-pill badge-m">æœˆ</span>
                                <span v-else class="badge-pill badge-q">å­£</span>
                                <i class="fas fa-trash-alt delete-btn no-print" @click="removeEtf(etf.id)"></i>
                            </div>
                            <div class="etf-name">{{ etf.name }}</div>
                        </div>
                    </td>
                    <td>
                        <div class="input-group-custom">
                            <input type="number" class="input-enhanced" 
                                   v-model.number="sharesData[etf.id]" @input="saveShares" placeholder="è‚¡æ•¸">
                            <input type="number" step="0.01" class="input-mini" 
                                   v-model.number="costData[etf.id]" @input="saveCosts" placeholder="å‡åƒ¹">
                        </div>
                    </td>
                    <td>
                        <input type="number" step="0.001" class="input-enhanced" 
                               v-model.number="getMonthDps(currentMonth)[etf.id]" @input="saveDps" placeholder="0">
                    </td>
                    <td class="amount-cell">
                        <div v-if="calcResult(etf).gross > 0">
                            <div class="amount-text">
                                {{ calcResult(etf).gross.toLocaleString() }}
                                <span v-if="calcResult(etf).nhFee > 0" title="éœ€æ‰£äºŒä»£å¥ä¿" style="font-size:10px;">ğŸ’Š</span>
                            </div>
                            <span v-if="calcResult(etf).nhFee > 0" class="sub-info nh-warning">
                                å¯¦é ˜: {{ (calcResult(etf).gross - calcResult(etf).nhFee).toLocaleString() }}
                            </span>
                            <span v-if="calcResult(etf).yield > 0" class="sub-info yield-text">
                                æ®–åˆ©ç‡: {{ calcResult(etf).yield }}%
                            </span>
                        </div>
                        <div v-else class="text-muted" style="font-size:12px; padding-top:4px;">-</div>
                    </td>
                </tr>
                <tr v-if="filteredList.length === 0">
                    <td colspan="4" class="text-center text-muted py-5">
                        <i class="fas fa-mug-hot fa-2x mb-2 text-secondary opacity-50"></i><br>
                        æœ¬æœˆç„¡å…¥å¸³æ¬¾é …
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="table-footer-row no-print" style="background:#f8f9fa;">
                    <td colspan="4" class="text-center p-2 text-muted" style="font-size:11px;">
                        * æ®–åˆ©ç‡ç‚ºè©²æ¬¡é…æ¯å¹´åŒ–ä¼°ç®— * ğŸ’Š ç‚ºäºŒä»£å¥ä¿æ‰£è²»æé†’
                    </td>
                </tr>
            </tfoot>
        </table>

        <div class="privacy-footer no-print">
            <i class="fas fa-shield-alt me-1"></i><strong>éš±ç§æ‰¿è«¾</strong>ï¼šæœ¬ç«™æ¡ç”¨é›¢ç·šæŠ€è¡“<br>
            æ‚¨çš„è³‡æ–™åƒ…å„²å­˜æ–¼æ‰‹æ©Ÿï¼Œçµ•ä¸ä¸Šå‚³ä¼ºæœå™¨ã€‚<br>
            <span style="opacity: 0.7; font-size: 10px;">è©¦ç®—çµæœåƒ…ä¾›åƒè€ƒï¼ŒéæŠ•è³‡å»ºè­°ã€‚</span>
        </div>
    </div>

    <div class="footer-bar no-print">
        <div class="d-flex flex-column justify-content-center">
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-2">{{ currentMonth }}æœˆ</span>
                <small>é ä¼°</small>
            </div>
        </div>
        <div class="text-end">
            <div class="total-amount">NT$ {{ monthlyTotals.gross.toLocaleString() }}</div>
            <div v-if="monthlyTotals.nhFee > 0" style="font-size:10px; color:#ffcccc;">
                (æ‰£è²»å¾Œç´„: {{ (monthlyTotals.gross - monthlyTotals.nhFee).toLocaleString() }})
            </div>
        </div>
    </div>

    <div class="modal fade" id="summaryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-warning bg-opacity-25 py-2">
                    <h6 class="modal-title fw-bold text-dark"><i class="fas fa-chart-bar me-2"></i>å¹´åº¦ç¸½è¦½</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div style="height: 200px; width: 100%; margin-bottom: 15px;">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                    <div style="max-height: 30vh; overflow-y: auto;">
                        <table class="table table-sm table-striped mb-0 text-center align-middle" style="font-size:13px;">
                            <thead class="sticky-top bg-white">
                                <tr><th>æœˆä»½</th><th>é‡‘é¡</th></tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in yearlySummary" :key="item.month" 
                                    :class="{'table-success fw-bold': item.month === currentMonth}">
                                    <td>{{ item.month }} æœˆ</td>
                                    <td>{{ item.total.toLocaleString() }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer py-2 justify-content-between bg-light">
                    <span class="small fw-bold text-secondary">å…¨å¹´åˆè¨ˆ</span>
                    <span class="fw-bold text-dark">NT$ {{ yearlyTotal.toLocaleString() }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addEtfModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success bg-opacity-10 py-2">
                    <h6 class="modal-title fw-bold text-success"><i class="fas fa-plus-circle me-2"></i>æ–°å¢ ETF</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="addEtf">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">ä»£è™Ÿ</label>
                            <input type="text" class="form-control" v-model="newEtf.id" required placeholder="ä¾‹å¦‚: 0050">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">åç¨±</label>
                            <input type="text" class="form-control" v-model="newEtf.name" required placeholder="ä¾‹å¦‚: å…ƒå¤§å°ç£50">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">é »ç‡</label>
                            <select class="form-select" v-model="newEtf.freq">
                                <option value="M">æœˆé…</option>
                                <option value="Q">å­£é…</option>
                            </select>
                        </div>
                        <div class="mb-3" v-if="newEtf.freq === 'Q'">
                            <label class="form-label small fw-bold">é…ç™¼æœˆä»½ (å…¥å¸³æ—¥)</label>
                            <select class="form-select" v-model="newEtf.group">
                                <option value="1">1, 4, 7, 10 æœˆ</option>
                                <option value="2">2, 5, 8, 11 æœˆ</option>
                                <option value="3">3, 6, 9, 12 æœˆ</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success fw-bold">åŠ å…¥æ¸…å–®</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- â˜… V33 æ›´æ–°ï¼šåŠ å…¥æ‰‹æ©Ÿå®‰è£æ•™å­¸ -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary bg-opacity-10 py-2">
                    <h6 class="modal-title fw-bold text-primary">ä½¿ç”¨æ•™å­¸èˆ‡è²æ˜</h6>
                    <span class="badge bg-success ms-2">v33.0</span>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body small">
                    
                    <!-- å®‰è£æ•™å­¸å€ -->
                    <div class="help-section">
                        <div class="help-title"><i class="fas fa-mobile-screen-button text-success"></i>å®‰è£åˆ°æ¡Œé¢ (æ¨è–¦)</div>
                        <p class="text-secondary mb-2">å°‡æœ¬ç«™åŠ å…¥ä¸»ç•«é¢ï¼Œé«”é©—å…¨è¢å¹•æ“ä½œï¼Œå°±åƒåŸç”Ÿ Appï¼</p>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="p-2 border rounded bg-light">
                                    <strong><i class="fab fa-apple"></i> iOS (Safari)</strong>
                                    <ol class="ps-3 mb-0 text-secondary" style="font-size: 11px;">
                                        <li>é»æ“Šä¸‹æ–¹ã€Œåˆ†äº«ã€<i class="fas fa-arrow-up-from-bracket"></i></li>
                                        <li>æ»‘å‹•é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</li>
                                        <li>é»æ“Šå³ä¸Šè§’ã€ŒåŠ å…¥ã€</li>
                                    </ol>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 border rounded bg-light">
                                    <strong><i class="fab fa-android"></i> Android (Chrome)</strong>
                                    <ol class="ps-3 mb-0 text-secondary" style="font-size: 11px;">
                                        <li>é»æ“Šå³ä¸Šè§’é¸å–® <i class="fas fa-ellipsis-vertical"></i></li>
                                        <li>é¸ã€ŒåŠ å…¥ä¸»ç•«é¢ã€æˆ–ã€Œå®‰è£ã€</li>
                                        <li>é»æ“Šã€Œæ–°å¢ã€</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <div class="help-title"><i class="fas fa-keyboard text-primary"></i>åŸºç¤æ“ä½œ</div>
                        <ul class="ps-3 text-secondary mb-0">
                            <li><strong>è‚¡æ•¸/é…æ¯</strong>ï¼šå¡«å¯«æ‚¨æŒæœ‰çš„è‚¡æ•¸èˆ‡æ¯è‚¡é…æ¯ã€‚</li>
                            <li><strong>æœˆä»½åˆ‡æ›</strong>ï¼šé»æ“Šä¸Šæ–¹ 1~12 æœˆï¼Œç³»çµ±æœƒè¨˜ä½æ¯æœˆçš„é…æ¯è¨­å®šã€‚</li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <div class="help-title"><i class="fas fa-calculator text-warning"></i>é€²éšè©¦ç®—</div>
                        <ul class="ps-3 text-secondary mb-0">
                            <li><strong>äºŒä»£å¥ä¿</strong>ï¼šå–®ç­† &ge; 20,000 å…ƒï¼Œæ‰£ 2.11% è£œå……ä¿è²»ï¼Œé¡¯ç¤º ğŸ’Š åœ–ç¤ºã€‚</li>
                            <li><strong>å¹´åŒ–æ®–åˆ©ç‡</strong>ï¼šè¼¸å…¥ã€Œå‡åƒ¹ã€å¾Œè‡ªå‹•è©¦ç®—ã€‚</li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <div class="help-title"><i class="fas fa-folder-open text-info"></i>è³‡æ–™å®‰å…¨</div>
                        <p class="text-secondary mb-1">æœ¬ç«™æ¡ç”¨<strong>é›¢ç·šé‹ç®—</strong>ï¼Œè³‡æ–™åƒ…å­˜åœ¨æ‰‹æ©Ÿä¸­ã€‚æ›æ‰‹æ©Ÿè«‹å‹™å¿…ï¼š</p>
                        <ul class="ps-3 text-secondary mb-0">
                            <li><strong>åŒ¯å‡ºå‚™ä»½</strong>ï¼šä¸‹è¼‰ JSON æª”æ¡ˆã€‚</li>
                            <li><strong>åŒ¯å…¥é‚„åŸ</strong>ï¼šä¸Šå‚³æª”æ¡ˆæ¢å¾©è³‡æ–™ã€‚</li>
                        </ul>
                    </div>

                    <div class="alert alert-light border mb-0 mt-2 text-center" style="font-size: 11px;">
                        <strong>å…è²¬è²æ˜</strong><br>
                        è©¦ç®—çµæœåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›é…æ¯é‡‘é¡ä»¥æŠ•ä¿¡å…¬å‘Šç‚ºæº–ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createApp, reactive, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            const savedMonth = localStorage.getItem('etf_user_last_month');
            const currentMonth = ref(savedMonth ? parseInt(savedMonth) : new Date().getMonth() + 1);
            watch(currentMonth, (newVal) => localStorage.setItem('etf_user_last_month', newVal));

            const fileInput = ref(null);
            const sharesData = ref({}); 
            const costData = ref({}); 
            const dpsData = ref({});
            const etfList = ref([]);
            let chartInstance = null;
            const newEtf = reactive({ id: '', name: '', freq: 'M', group: '1' });

            const defaultEtfs = [
                { id: '0056', name: 'å…ƒå¤§é«˜è‚¡æ¯', freq: 'Q', months: [2,5,8,11] },
                { id: '00720B', name: 'å…ƒå¤§æŠ•å‚µ', freq: 'Q', months: [2,5,8,11] },
                { id: '00878', name: 'åœ‹æ³°æ°¸çºŒ', freq: 'Q', months: [3,6,9,12] },
                { id: '00850', name: 'å…ƒå¤§æ°¸çºŒ', freq: 'Q', months: [3,6,9,12] },
                { id: '00891', name: 'ä¸­ä¿¡é—œéµ', freq: 'Q', months: [3,6,9,12] },
                { id: '00713', name: 'é«˜æ¯ä½æ³¢', freq: 'Q', months: [1,4,7,10] },
                { id: '00915', name: 'å‡±åŸºé«˜æ¯', freq: 'Q', months: [1,4,7,10] },
                { id: '00918', name: 'å¤§è¯å„ªåˆ©é«˜å¡«æ¯', freq: 'Q', months: [1,4,7,10] },
                { id: '00919', name: 'ç¾¤ç›Šå°ç£ç²¾é¸', freq: 'Q', months: [1,4,7,10] },
                { id: '00900', name: 'å¯Œé‚¦ç‰¹é¸', freq: 'M', months: [] },
                { id: '00740B', name: 'å…¨çƒæŠ•å‚µ', freq: 'M', months: [] },
                { id: '00929', name: 'å¾©è¯å°ç£ç§‘æŠ€', freq: 'M', months: [] },
                { id: '00934', name: 'ä¸­ä¿¡æˆé•·é«˜è‚¡', freq: 'M', months: [] },
                { id: '00936', name: 'å°æ–°æ°¸çºŒé«˜æ¯', freq: 'M', months: [] },
                { id: '00939', name: 'çµ±ä¸€é«˜æ¯å‹•èƒ½', freq: 'M', months: [] },
                { id: '00940', name: 'å…ƒå¤§å°ç£åƒ¹å€¼', freq: 'M', months: [] },
                { id: '00950B', name: 'å‡±åŸºAç´šå‚µ', freq: 'M', months: [] },
                { id: '00959B', name: 'å¤§è¯æŠ•ç­‰å‚µ', freq: 'M', months: [] },
                { id: '00772B', name: 'ä¸­ä¿¡é«˜è©•ç´š', freq: 'M', months: [] },
            ];

            for(let m=1; m<=12; m++) dpsData.value[m] = {};

            const loadData = () => {
                const tryLoad = (keyPrefix) => localStorage.getItem(keyPrefix);

                // Config
                let savedConfig = tryLoad('etf_config_v33') || tryLoad('etf_config_v32') || tryLoad('etf_config_v31') || tryLoad('etf_config_v30');
                if (savedConfig) etfList.value = JSON.parse(savedConfig);
                else { etfList.value = JSON.parse(JSON.stringify(defaultEtfs)); }

                // Shares
                let savedShares = tryLoad('etf_shares_v33') || tryLoad('etf_shares_v32') || tryLoad('etf_shares_v31') || tryLoad('etf_shares_v30');
                if(savedShares) sharesData.value = JSON.parse(savedShares);
                else { initDefaultShares(); }

                // Costs
                let savedCosts = tryLoad('etf_costs_v33') || tryLoad('etf_costs_v32') || tryLoad('etf_costs_v31') || tryLoad('etf_costs_v30');
                if(savedCosts) costData.value = JSON.parse(savedCosts);
                
                // DPS
                let savedDps = tryLoad('etf_dps_v33') || tryLoad('etf_dps_v32') || tryLoad('etf_dps_v31') || tryLoad('etf_dps_v30');
                if(savedDps) dpsData.value = JSON.parse(savedDps);

                saveEtfConfig(); saveShares(); saveCosts(); saveDps();
            };

            const initDefaultShares = () => {
                const temp = {};
                etfList.value.forEach(e => temp[e.id] = 0);
                sharesData.value = temp;
            };

            const saveEtfConfig = () => localStorage.setItem('etf_config_v33', JSON.stringify(etfList.value));
            const saveShares = () => localStorage.setItem('etf_shares_v33', JSON.stringify(sharesData.value));
            const saveCosts = () => localStorage.setItem('etf_costs_v33', JSON.stringify(costData.value));
            const saveDps = () => localStorage.setItem('etf_dps_v33', JSON.stringify(dpsData.value));

            const getMonthDps = (m) => {
                if(!dpsData.value[m]) dpsData.value[m] = {};
                return dpsData.value[m];
            };

            const isHighlight = (etf) => etf.freq !== 'M' && etf.months.includes(currentMonth.value);

            const filteredList = computed(() => {
                let list = etfList.value.filter(etf => {
                    if(etf.freq === 'M') return true;
                    return etf.months.includes(currentMonth.value);
                });
                return list.sort((a, b) => isHighlight(b) - isHighlight(a));
            });

            const calcResult = (etf) => {
                const s = sharesData.value[etf.id] || 0;
                const d = (dpsData.value[currentMonth.value] && dpsData.value[currentMonth.value][etf.id]) || 0;
                const cost = costData.value[etf.id] || 0;
                
                const gross = Math.round(s * d);
                let nhFee = 0;
                if(gross >= 20000) {
                    nhFee = Math.floor(gross * 0.0211);
                }

                let y = 0;
                if(cost > 0 && d > 0) {
                    const annualFactor = (etf.freq === 'M') ? 12 : 4;
                    y = ((d * annualFactor) / cost * 100).toFixed(2);
                }
                return { gross, nhFee, yield: y };
            };

            const monthlyTotals = computed(() => {
                let gross = 0;
                let nhFee = 0;
                filteredList.value.forEach(etf => {
                    const res = calcResult(etf);
                    gross += res.gross;
                    nhFee += res.nhFee;
                });
                return { gross, nhFee };
            });

            const yearlySummary = computed(() => {
                const summary = [];
                for (let m = 1; m <= 12; m++) {
                    let total = 0;
                    etfList.value.forEach(etf => {
                        const isPayMonth = (etf.freq === 'M') || etf.months.includes(m);
                        if(isPayMonth) {
                            const s = sharesData.value[etf.id] || 0;
                            const d = (dpsData.value[m] && dpsData.value[m][etf.id]) || 0;
                            total += Math.round(s * d);
                        }
                    });
                    summary.push({ month: m, total: total });
                }
                return summary;
            });

            const yearlyTotal = computed(() => yearlySummary.value.reduce((sum, i) => sum + i.total, 0));

            const openSummary = () => {
                const modal = new bootstrap.Modal(document.getElementById('summaryModal'));
                modal.show();
                nextTick(() => { renderChart(); });
            };

            const renderChart = () => {
                const ctx = document.getElementById('yearlyChart');
                if(!ctx) return;
                if(chartInstance) chartInstance.destroy();
                const dataValues = yearlySummary.value.map(i => i.total);
                const labels = yearlySummary.value.map(i => i.month + 'æœˆ');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ¯æœˆé ˜æ¯', data: dataValues,
                            backgroundColor: 'rgba(25, 135, 84, 0.6)', borderColor: 'rgba(25, 135, 84, 1)', borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } }
                    }
                });
            };

            const shareApp = async () => {
                const shareData = {
                    title: 'ETF ç¾é‡‘æµè©¦ç®—ç¥å™¨',
                    text: 'æˆ‘ç™¼ç¾é€™å€‹å­˜è‚¡è¨ˆç®—æ©Ÿè¶…å¥½ç”¨ï¼è‡ªå‹•ç®—äºŒä»£å¥ä¿è·Ÿæ®–åˆ©ç‡ï¼Œæ¨è–¦çµ¦ä½  ğŸ‘‡',
                    url: window.location.href
                };

                if (navigator.share) {
                    try { await navigator.share(shareData); } catch (err) {}
                } else {
                    try {
                        await navigator.clipboard.writeText(window.location.href);
                        alert('ç¶²å€å·²è¤‡è£½ï¼å¿«å»è²¼çµ¦æœ‹å‹å§ï¼');
                    } catch (err) { alert('ä¸æ”¯æ´è‡ªå‹•åˆ†äº«'); }
                }
            };

            const addEtf = () => {
                if(etfList.value.some(e => e.id === newEtf.id)) { alert('å·²å­˜åœ¨'); return; }
                let months = [];
                if(newEtf.freq === 'Q') {
                    if(newEtf.group === '1') months = [1,4,7,10];
                    if(newEtf.group === '2') months = [2,5,8,11];
                    if(newEtf.group === '3') months = [3,6,9,12];
                }
                etfList.value.push({ id: newEtf.id, name: newEtf.name, freq: newEtf.freq, months });
                sharesData.value[newEtf.id] = 0; 
                saveEtfConfig(); saveShares();
                alert('æ–°å¢æˆåŠŸ'); newEtf.id=''; newEtf.name='';
            };

            const removeEtf = (id) => {
                if(confirm('ç¢ºå®šç§»é™¤ï¼Ÿ')) {
                    etfList.value = etfList.value.filter(e => e.id !== id);
                    saveEtfConfig();
                }
            };

            const resetToDefault = () => {
                if(confirm('é‡ç½®å°‡æ¢å¾©é è¨­æ¸…å–®ä¸¦æ¸…ç©ºè‚¡æ•¸ï¼Œç¢ºå®šï¼Ÿ')) {
                    etfList.value = JSON.parse(JSON.stringify(defaultEtfs));
                    initDefaultShares();
                    costData.value = {};
                    saveEtfConfig(); saveShares(); saveCosts();
                    alert('å·²é‡ç½®');
                }
            };

            const exportCSV = () => {
                let csv = "\uFEFFä»£è™Ÿ,åç¨±,è‚¡æ•¸,å‡åƒ¹,é…æ¯,ç¸½é¡,äºŒä»£å¥ä¿,æ®–åˆ©ç‡\n";
                filteredList.value.forEach(e => {
                    const res = calcResult(e);
                    csv += `${e.id},${e.name},${sharesData.value[e.id]||0},${costData.value[e.id]||0},${dpsData.value[currentMonth.value]?.[e.id]||0},${res.gross},${res.nhFee},${res.yield}%\n`;
                });
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `ETF_v33_${currentMonth.value}æœˆ.csv`;
                link.click();
            };

            const backupDataJSON = () => {
                const backup = { config: etfList.value, shares: sharesData.value, costs: costData.value, dps: dpsData.value, ver: 'v33' };
                const blob = new Blob([JSON.stringify(backup)], { type: "application/json" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `ETF_Backup_v33.json`;
                link.click();
            };

            const triggerImport = () => fileInput.value.click();
            const handleFileImport = (e) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        if(confirm('åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ')) {
                            if(d.config) etfList.value = d.config;
                            if(d.shares) sharesData.value = d.shares;
                            if(d.costs) costData.value = d.costs;
                            if(d.dps) dpsData.value = d.dps;
                            saveEtfConfig(); saveShares(); saveCosts(); saveDps();
                            alert('åŒ¯å…¥æˆåŠŸ');
                        }
                    } catch(err){ alert('æ ¼å¼éŒ¯èª¤'); }
                };
                reader.readAsText(e.target.files[0]);
            };

            const printPage = () => window.print();

            onMounted(() => loadData());

            return {
                currentMonth, sharesData, costData, getMonthDps,
                filteredList, isHighlight, saveShares, saveCosts, saveDps,
                calcResult, monthlyTotals,
                yearlySummary, yearlyTotal, openSummary,
                exportCSV, printPage, backupDataJSON, triggerImport, handleFileImport, fileInput,
                newEtf, addEtf, removeEtf, resetToDefault, shareApp
            };
        }
    }).mount('#app');
</script>

</body>
</html>
